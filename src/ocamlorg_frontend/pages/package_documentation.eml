let module_explorer
~str_path
~maptoc
(package : Package_intf.package)
=
  <div class="flex flex-col font-normal text-body-400" id="htmx-sidebar">
    <div class="space-y-6 flex flex-col overflow-x:scroll">
      <div>
      <%s! Navmap.render ~package ~path:str_path maptoc %>
      </div>
    </div>
  </div>

let on_this_page
~toc
=
  <div class="font-semibold text-gray-500 text-sm mb-4">ON THIS PAGE</div>
  <%s! Toc.render toc %>

let render
~title
~(path: Package_breadcrumbs.path)
~toc
~maptoc
~content
(package : Package_intf.package) =
let str_path =
  match path with
    | Overview -> []
    | Documentation (docs_path) -> (match docs_path with
        | Package_breadcrumbs.Index -> []
        | Library (s, p) -> s :: List.map (function
            | Package_breadcrumbs.Module s -> s
            | ModuleType s -> s
            | Parameter (number, s) -> Int.to_string number ^ "-" ^ s
            | Class s -> s
            | ClassType s -> s
          ) p
        | Page s -> [""; s])
in
let path_page = match str_path |> String.concat "/" with
                | "" -> None
                | path -> Some (path ^ if String.contains path '.' then "" else "/index.html") in
Package_layout.render
~title
~description:(Printf.sprintf "%s %s: %s" package.name package.version package.description)
~package
~path
~canonical:(Url.package_doc package.name package.version ?page:path_page)
~styles:["/css/main.css"; "/css/doc.css"] @@
<div x-data="{ open: false, sidebar: window.innerWidth > 1024 && true, showOnMobile: false}" @resize.window="sidebar = window.innerWidth > 1024" x-on:close-sidebar="sidebar=window.innerWidth > 1024 && true">
  <button :title='(sidebar? "close" : "open")+" sidebar"' aria-pressed="false" :aria-pressed="sidebar" class="flex items-center bg-primary-600 p-3 z-30 rounded-full text-white shadow-md bottom-20 fixed lg:hidden right-10"
    x-on:click="sidebar = ! sidebar">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24">
      <path d="M14.25 14.375H19.875C20.4962 14.375 21 13.8712 21 13.25V9.875C21 9.25377 20.4962 8.75 19.875 8.75H14.25C13.6288 8.75 13.125 9.25377 13.125 9.875V11H7.5V7.625H9.75C10.3712 7.625 10.875 7.12122 10.875 6.5V3.125C10.875 2.50378 10.3712 2 9.75 2H4.125C3.50378 2 3 2.50378 3 3.125V6.5C3 7.12122 3.50378 7.625 4.125 7.625H6.375V19.4375C6.375 19.7482 6.62677 20 6.9375 20H13.125V21.125C13.125 21.7462 13.6288 22.25 14.25 22.25H19.875C20.4962 22.25 21 21.7462 21 21.125V17.75C21 17.1288 20.4962 16.625 19.875 16.625H14.25C13.6288 16.625 13.125 17.1288 13.125 17.75V18.875H7.5V12.125H13.125V13.25C13.125 13.8712 13.6288 14.375 14.25 14.375ZM14.25 9.875H19.875V13.25H14.25V9.875ZM4.125 6.5V3.125H9.75V6.5H4.125ZM14.25 17.75H19.875V21.125H14.25V17.75Z" fill="white"/>
    </svg>
    <span class="hidden md:flex font-semibold px-2">side menu</span>
  </button>
  <div class="fixed z-10 inset-0 bg-background-dark-blue/20 backdrop-blur-sm lg:hidden"
    :class='sidebar ? "" : "hidden"' aria-hidden="true" x-on:click="sidebar = ! sidebar"></div>

  <div class="flex flex-col lg:flex-row md:gap-12">
    <div
      class="p-10 z-20 bg-white flex-col fixed h-screen lg:pr-0 lg:flex left-0 top-0 lg:sticky w-72 lg:p-0"
      x-show="sidebar" x-transition:enter="transition duration-200 ease-out"
      x-transition:enter-start="-translate-x-full" x-transition:leave="transition duration-100 ease-in"
      x-transition:leave-end="-translate-x-full">

      <div class="package_documentation__tabs">
        <!-- GUIDES -->
        <input class="package_documentation__input" name="tabs" type="radio" id="tabone">
        <label class="package_documentation__label" for="tabone">DOCS</label>
        <div class="package_documentation__panel overflow-auto h-screen pt-6" tabindex="0">
          <p>Coming soon...</p>
        </div>

        <!-- MODULES -->
        <input class="package_documentation__input" name="tabs" type="radio" id="tabtwo" checked="checked">
        <label class="package_documentation__label" for="tabtwo">MODULES</label>
        <div class="package_documentation__panel overflow-auto h-screen pt-6" tabindex="0">
          <%s! module_explorer ~str_path ~maptoc package %>
        </div>

        <!-- CONTENT -->
        <input class="package_documentation__input" name="tabs" type="radio" id="tabthree">
        <label class="xl:hidden package_documentation__label" for="tabthree" >INDEX</label>
        <div class="package_documentation__panel overflow-auto h-screen pt-6" tabindex="0" id="htmx-on-this-page">
          <%s! on_this_page ~toc %>
        </div>
      </div>
    </div>
    <div class="flex-1 z-0 z- min-w-0 lg:max-w-3xl" id="htmx-content">
      <div class="odoc prose prose-orange">
        <div class="relative w-full text-gray-400 focus-within:text-gray-600">
          <input
            name="q"
            id="package_search"
            class="w-full appearance-none focus:ring-orange-500 focus:border-primary-600 text-body-600 border py-3 pr-6 border-gray-200 pl-14 h-full"
            placeholder="Search in this package..."
            type="search"
            value="">
          <div class="absolute h-full flex items-center pl-6 opacity-60 left-0 top-0">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-body-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="rgba(26, 32, 44, 1)"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>
        </div>

        <%s! content %>
      </div>
    </div>
    <div class="hidden xl:flex top-0 sticky h-screen flex-col w-60 overflow-auto lg:pt-6" id="htmx-right-sidebar">
      <%s! on_this_page ~toc %>
    </div>
  </div>
</div>
<script>
window.onload = (event) => {
  document.body.addEventListener('htmx:afterSwap', (evt) => {
    if (evt.detail.error || evt.detail.failed) {
      window.location = evt.detail.requestConfig.path;
      return;
    }
    window.pageYOffset = 0;
    evt.detail.elt.dispatchEvent(new CustomEvent('close-sidebar', { bubbles: true }));
  });
  document.body.addEventListener('htmx:swapError', (evt) => {
    window.location = evt.detail.requestConfig.path;
  });
  document.body.addEventListener('htmx:responseError', (evt) => {
    window.location = evt.detail.requestConfig.path;
  });
  document.body.addEventListener('htmx:historyCacheMissError', (evt) => {
    window.location = evt.detail.path;
  });
  document.body.addEventListener('htmx:onLoadError', (evt) => {
    window.location = evt.detail.requestConfig.path;
  });
};
</script>
